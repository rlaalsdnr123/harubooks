<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<div class="content-wrapper">
	<div class="row" style="padding: 20px;">
		<div class="col-lg-12 grid-margin stretch-card">
			<div class="card">
				<div class="card-body">
					<h4 class="card-title">판매 관리</h4>
					<div class="row">
						<div class="col-md-12 grid-margin stretch-card">
							<div class="card position-relative">
								<div class="card-body">
									<div id="detailedReports" class="carousel slide detailed-report-carousel position-static pt-2" data-ride="carousel">
										<div class="carousel-inner">
											<div class="carousel-item active">
												<div class="row">
													<div class="col-md-12 col-xl-2 d-flex flex-column justify-content-start">
														<div class="ml-xl-4 mt-3">
															<p class="card-title">매출액</p>
															<h2 class="text-primary">Best 5</h2>
															<h4 class="font-weight-500 mb-xl-4 text-primary">출판사</h4>
														</div>  
													</div>
													<div class="col-md-12 col-xl-10">
														<div class="row">
															<div class="col-md-6 mt-3">
																<div id="" style="width: 400px; height: 400px;">
																	<canvas id="myChart1" width="300" height="300"></canvas>
																</div>
															</div>
															<div class="col-md-6 mt-3">
																<div id="" style="width: 400px; height: 400px;">
																	<canvas id="myChart2" width="300" height="300"></canvas>
																</div>
															</div>
														</div>
													</div>
												</div>
											</div>
											<div class="carousel-item">
												<div class="row">
													<div class="col-md-12 col-xl-2 d-flex flex-column justify-content-start">
														<div class="ml-xl-4 mt-3">
															<p class="card-title">판매량</p>
															<h2 class="text-primary">Best 5</h2>
															<h4 class="font-weight-500 mb-xl-4 text-primary">도서</h4>
														</div>  
													</div>
													<div class="col-md-12 col-xl-10">
														<div class="row">
															<div class="col-md-6 mt-3">
																<div id="" style="width: 400px; height: 400px;">
																	<canvas id="myChart3" width="300" height="300"></canvas>
																</div>
															</div>
															<div class="col-md-6 mt-3">
																<div id="" style="width: 400px; height: 400px;">
																	<canvas id="myChart4" width="300" height="300"></canvas>
																</div>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
										<a class="carousel-control-prev" href="#detailedReports" role="button" data-slide="prev">
											<span class="carousel-control-prev-icon" aria-hidden="true"></span>
											<span class="sr-only">Previous</span>
										</a>
										<a class="carousel-control-next" href="#detailedReports" role="button" data-slide="next">
											<span class="carousel-control-next-icon" aria-hidden="true"></span>
											<span class="sr-only">Next</span>
										</a>
									</div>
								</div>
							</div>
						</div>
					</div>
					<form action="" method="post" id="searchForm">
						<input type="hidden" name="page" id="page"/>
						<div class="col-lg-12">
							<div class="row dropdown" style="float:right; margin-bottom: 5px; margin-right: -22px;">
								<select id="option" name="searchType" style="width: 100px; border: 1px solid lightgray;">
									<option value="title">도서명</option>
									<option value="publisher">출판사</option>
								</select>
								<ul class="navbar-nav mr-lg-2">
									<li class="nav-item nav-search d-none d-lg-block">
										<div class="input-group">
											<input type="text" class="form-control" name="searchWord" id="searchWord" placeholder="검색" aria-label="search" aria-describedby="search"/>
											<div class="input-group-prepend hover-cursor" id="navbar-search-icon">
												<button type="button" id="search" style="width: 100px; border: 1px solid lightgray;">검색
													<i class="icon-search"></i>
												</button>
											</div>
										</div>
									</li>
								</ul>
							</div>
						</div>
					</form>
					<p class="card-description">전체 <code><span id="salesCount"></span></code>건</p>
					<div class="table-responsive">
						<table class="table table-hover">
							<thead>
								<tr class="table-primary">
									<th style="width : 5%; text-align : center;">번호</th>
									<th style="width : 10%; text-align : center;">주문번호</th>
									<th style="width : 10%; text-align : center;">주문일자</th>
									<th style="width : 40%; text-align : center;">도서명</th>
									<th style="width : 20%; text-align : center;">출판사</th>
									<th style="width : 10%; text-align : center;">매출액</th>
									<th style="width : 5%; text-align : center;">판매량</th>
								</tr>
							</thead>
							<tbody id="salesList">
							</tbody>
						</table>
					</div>
				</div>
				<div id="pagingArea"></div>
			</div>
		</div>
	</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script type="text/javascript">
var salesList = document.querySelector("#salesList");
var salesCount = document.querySelector("#salesCount");
var search = document.querySelector("#search");
var option = document.querySelector("#option");
var searchType = document.querySelector("#option").value;
var searchWord = document.querySelector("#searchWord").value;
var pagingArea = document.querySelector("#pagingArea");
var page = 1;

window.onload = function(){
	list();
	pagingArea.addEventListener("click", function(event) {
		if(event.target.tagName === "A") {
			event.preventDefault();
			page = event.target.getAttribute("data-page");
			list();
		}
	});
}

search.addEventListener("click", function() {
	page = 1;
	console.log("searchClick");
	searchWord = document.querySelector("#searchWord").value;
	list();
});

option.addEventListener("change", function() {
	searchType = document.querySelector("#option").value;
	if(serachType != null){
		list();
	}else{
		list();
		console.log("매출 목록이 존재하지 않습니다.");
	}
});

function list() {
	var list = document.querySelector("#salesList");
	list.innerHTML = '';
	$.ajax({
		type : "get",
		url : "sales/selectSalesList",
		data : {
			searchType:searchType,
			searchWord:searchWord,
			page:page
		},
		contentType : "application/json; charset=utf-8",
		beforeSend : function(xhr) {
			xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
		},
		success : function(result){
			console.log("result : " + result);
			console.log(JSON.stringify(result));
			var html = "";
			if(result.pagingVO.dataList.length == 0){
				html += "<tr>"
				html += `<td colspan="7" align="center">매출 목록이 존재하지 않습니다.</td>`
				html += "</tr>"
			} else {
				for (var i = 0; i < result.pagingVO.dataList.length; i++) {
					console.log(result.pagingVO.dataList[i].book_title);
					console.log(result.pagingVO.dataList[i].pl_prchs_amt);
					console.log(result.pagingVO.dataList[i].pl_prchs_amt.toLocaleString());
					html += "<tr>"
					html += "<td style='text-align : center;'>"+ result.pagingVO.dataList[i].rnum +"</td>"
					html += "<td style='text-align : center;'>"+ result.pagingVO.dataList[i].order_no +"</td>"
					html += "<td style='text-align : center;'>"+ result.pagingVO.dataList[i].order_ymd +"</td>"
					html += "<td style='text-align : left;'>"+ result.pagingVO.dataList[i].book_title +"</td>"
					html += "<td style='text-align : center;'>"+ result.pagingVO.dataList[i].pub_nm +"</td>"
					html += "<td style='text-align : right;'>"+ result.pagingVO.dataList[i].pl_prchs_amt.toLocaleString() +"</td>"
					html += "<td style='text-align : right;'>"+ result.pagingVO.dataList[i].pl_cnt.toLocaleString() +"</td>"
					html += "</tr>"
				}
				$("table tbody").append(html);
				//salesList.innerHTML += html;
			}
			pagingArea.innerHTML = result.pagingVO.pagingHTML;
			salesCount.innerText = result.pagingVO.totalRecord;
			getBestPublisher();
			getMonthlySales();
			getBestBooks();
			getMonthlySalesVolume();
		},
		error: function(error) {
			console.log("error");
		}
	});
}

//출판사 Best5 차트
function getBestPublisher() {
	let publisherList = [];
	let totalSalesList = [];
	$.ajax({
		type : "get",
		url : "sales/bestPublisher",
		data : "",
		contentType : "application/json; charset=utf-8",
		beforeSend : function(xhr) {
			xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
		},
		success : function(data){
			console.log("data : " + data);
			console.log(JSON.stringify(data));
			for(let i = 0; i < data.length; i++){
				publisherList.push(data[i].PUB_NM);
				totalSalesList.push(data[i].TOTAL_SALES);
			}
			console.log(publisherList);
			console.log(totalSalesList);
			// 그래프
			const ctx1 = document.getElementById('myChart1').getContext('2d');
			const myChart1 = new Chart(ctx1, {
				type: 'doughnut',
				data: {
					labels: publisherList,
					datasets: [{
						label: '# of Votes',
						data: totalSalesList,
						backgroundColor: [
							'rgba(255, 99, 132, 0.2)',
							'rgba(54, 162, 235, 0.2)',
							'rgba(255, 206, 86, 0.2)',
							'rgba(75, 192, 192, 0.2)',
							'rgba(153, 102, 255, 0.2)',
							'rgba(255, 159, 64, 0.2)'
						],
						borderColor: [
							'rgba(255, 99, 132, 1)',
							'rgba(54, 162, 235, 1)',
							'rgba(255, 206, 86, 1)',
							'rgba(75, 192, 192, 1)',
							'rgba(153, 102, 255, 1)',
							'rgba(255, 159, 64, 1)'
						],
						borderWidth: 1
					}]
				},
			});
		},
		error: function(error) {
			console.log("error");
		}
	});
}

// 월별 매출액 차트
function getMonthlySales() {
	let publisherList = [];
	let totalSalesList = [];
	$.ajax({
		type : "get",
		url : "sales/bestPublisher",
		data : "",
		contentType : "application/json; charset=utf-8",
		beforeSend : function(xhr) {
			xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
		},
		success : function(data){
			console.log("data : " + data);
			console.log(JSON.stringify(data));
			for(let i = 0; i < data.length; i++){
				publisherList.push(data[i].pub_nm);
				totalSalesList.push(data[i].total_sales);
			}
			console.log(publisherList);
			console.log(totalSalesList);
			// 그래프
			const ctx2 = document.getElementById('myChart2').getContext('2d');
			const myChart2 = new Chart(ctx2, {
				type: 'bar',
				data: {
					labels: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
					datasets: [{
						label: '매출액',
						data: [500000, 600000, 350000, 490000, 700000, 648000, 600000, 350000, 490000, 700000, 648000],
						backgroundColor: [
							'rgba(255, 99, 132, 0.2)',
							'rgba(54, 162, 235, 0.2)',
							'rgba(255, 206, 86, 0.2)',
							'rgba(75, 192, 192, 0.2)',
							'rgba(153, 102, 255, 0.2)',
							'rgba(255, 159, 64, 0.2)'
						],
						borderColor: [
							'rgba(255, 99, 132, 1)',
							'rgba(54, 162, 235, 1)',
							'rgba(255, 206, 86, 1)',
							'rgba(75, 192, 192, 1)',
							'rgba(153, 102, 255, 1)',
							'rgba(255, 159, 64, 1)'
						],
						borderWidth: 1
					}]
				},
			});
		},
		error: function(error) {
			console.log("error");
		}
	});	
}

//도서 Best5 차트
function getBestBooks() {
	let bookTitleList = [];
	let plCntList = [];
	$.ajax({
		type : "get",
		url : "sales/bestBooks",
		data : "",
		contentType : "application/json; charset=utf-8",
		beforeSend : function(xhr) {
			xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
		},
		success : function(data){
			console.log("data : " + data);
			console.log(JSON.stringify(data));
			for(let i = 0; i < data.length; i++){
				bookTitleList.push(data[i].book_title);
				plCntList.push(data[i].pl_cnt);
			}
			console.log(bookTitleList);
			console.log(plCntList);
			// 그래프
			const ctx3 = document.getElementById('myChart3').getContext('2d');
			const myChart3 = new Chart(ctx3, {
				type: 'doughnut',
				data: {
					labels: bookTitleList,
					datasets: [{
						label: '# of Votes',
						data: plCntList,
						backgroundColor: [
							'rgba(255, 99, 132, 0.2)',
							'rgba(54, 162, 235, 0.2)',
							'rgba(255, 206, 86, 0.2)',
							'rgba(75, 192, 192, 0.2)',
							'rgba(153, 102, 255, 0.2)',
							'rgba(255, 159, 64, 0.2)'
						],
						borderColor: [
							'rgba(255, 99, 132, 1)',
							'rgba(54, 162, 235, 1)',
							'rgba(255, 206, 86, 1)',
							'rgba(75, 192, 192, 1)',
							'rgba(153, 102, 255, 1)',
							'rgba(255, 159, 64, 1)'
						],
						borderWidth: 1
					}]
				},
			});
		},
		error: function(error) {
			console.log("error");
		}
	});
}

// 월별 판매량 차트
function getMonthlySalesVolume() {
	let publisherList = [];
	let totalSalesList = [];
	$.ajax({
		type : "get",
		url : "sales/bestPublisher",
		data : "",
		contentType : "application/json; charset=utf-8",
		beforeSend : function(xhr) {
			xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
		},
		success : function(data){
			console.log("data : " + data);
			console.log(JSON.stringify(data));
			for(let i = 0; i < data.length; i++){
				publisherList.push(data[i].pub_nm);
				totalSalesList.push(data[i].total_sales);
			}
			console.log(publisherList);
			console.log(totalSalesList);
			// 그래프
			const ctx4 = document.getElementById('myChart4').getContext('2d');
			const myChart4 = new Chart(ctx4, {
				type: 'bar',
				data: {
					labels: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
					datasets: [{
						label: '판매량',
						data: [100, 200, 500, 370, 850, 630, 509, 370, 850, 630, 509],
						backgroundColor: [
							'rgba(255, 99, 132, 0.2)',
							'rgba(54, 162, 235, 0.2)',
							'rgba(255, 206, 86, 0.2)',
							'rgba(75, 192, 192, 0.2)',
							'rgba(153, 102, 255, 0.2)',
							'rgba(255, 159, 64, 0.2)'
						],
						borderColor: [
							'rgba(255, 99, 132, 1)',
							'rgba(54, 162, 235, 1)',
							'rgba(255, 206, 86, 1)',
							'rgba(75, 192, 192, 1)',
							'rgba(153, 102, 255, 1)',
							'rgba(255, 159, 64, 1)'
						],
						borderWidth: 1
					}]
				},
			});
		},
		error: function(error) {
			console.log("error");
		}
	});	
}
</script>