<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="sec" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
<link rel="stylesheet" href="/resources/assets/css/myPage.css">
<link rel="stylesheet" href="/resources/assets/css/prod-order.css">
<body>
	<div id="container">
		<div id="sidebar">
			<div>
				<p style="font-weight: bold;font-size: 24px;">마이페이지</p>
			</div>
			<div id="myInfo">
				<div class="info" style="display: flex;flex-direction: column;">
					<div style="display: flex;margin: 0 auto; flex-direction: column;">
						<p style="font-size: 18px;color: white;margin: 5px;font-weight: bold;">${userInfo.user_nm }님</p>
						<div style="background-color: #3cb454;height: 24px;border-radius: 15px;"><p style="margin-bottom: 0px;color: white;text-align: center;font-weight: bold;">${userInfo.rank_name }</p></div>
					</div>
					<div id="info-1" style="display: flex;flex-direction: column;width: 90%;margin: 0 auto;margin-top: 20px;">
						<div style="display: flex;justify-content: space-between;align-items: center;">
							<p style="font-size: 13px;color: white;">보유 마일리지</p><p style="font-size: 15px;color: white;font-weight: bold;">${userInfo.mbr_mileage }P</p>
						</div>
						<div style="display: flex;justify-content: space-between;align-items: center;">
							<p style="font-size: 13px;color: white;">찜 목록</p><p style="font-size: 15px;color: white;font-weight: bold;">${wishCnt }개</p>
						</div>
						<div style="display: flex;justify-content: space-between;align-items: center;">
							<p style="font-size: 13px;color: white;">장바구니</p><p style="font-size: 15px;color: white;font-weight: bold;">${cartCnt }개</p>
						</div>
					</div>
				</div>
			</div>
			<div id="category">
				<div class="categoryInfo">
					<p>쇼핑내역</p>
					<a href="#" >주문/배송목록</a>
					<a href="#" >구매확정목록</a>
					<a href="#" >환불내역</a>
					<a href="#" >찜 목록</a>
					<a href="#" >장바구니 목록</a>
				</div>
				<div class="categoryInfo">
					<p>문의 내역</p>
					<a href="#" >1:1문의</a>
				</div>
				<div class="categoryInfo">
					<p>나의 정보</p>
					<a href="#" >내 정보 수정</a>
				</div>
			</div>
		</div>
		<div id="content">
			<div>
				<p style="font-size: 18px;font-weight: bold;">주문/배송 목록</p>
			</div>
			<div id="contentInfo">
				<div class="deliveryInfo" style="width: 24%;">
					<div>
						<p class="di-1">주문내역</p>
					</div>
					<div>
						<p class="di-2">주문/배송안내</p>
					</div>
				</div>
				<div class="deliveryInfo" style="width: 18%;">
					<div>
						<p class="di-1">${preparedDelivery }</p>
					</div>
					<div>
						<p class="di-2">배송 준비중</p>
					</div>
				</div>
				<div class="deliveryInfo" style="width: 18%;">
					<div>
						<p class="di-1">${DeliveringCnt }</p>
					</div>
					<div>
						<p class="di-2">배송중</p>
					</div>
				</div>
				<div class="deliveryInfo" style="width: 18%;">
					<div>
						<p class="di-1">${finishDelivery }</p>
					</div>
					<div>
						<p class="di-2">배송완료</p>
					</div>
				</div>
				<div class="deliveryInfo" style="width: 18%; border: none;">
					<div>
						<p class="di-1">${refundCnt }</p>
					</div>
					<div>
						<p class="di-2">환불</p>
					</div>
				</div>
			</div>
			<div id="prodInfo">
				<div>
					<p style="font-size: 18px; font-weight: bold;">최근 구매한 책</p>
				</div>
				<div id="currentPurchase">
					<div style=" display: flex; flex-direction: column;">
						<p style="font-size: 16px; font-weight: bold; margin-right: 100px;"class="semi-title">주문상품</p>
					</div>
					<div id="printCurrentProd" style="display: flex;flex-direction: column;">						
					</div>
				</div>
			</div>
			<div id="prodInfo">
				<div>
					<p style="font-size: 18px; font-weight: bold;">배송 완료된 책</p>
				</div>
				<div id="currentPurchase">
					<div style="border-bottom:1px solid #d5d5d5; display: flex; flex-direction: column;">
						<p style="font-size: 16px; font-weight: bold; margin-right: 100px;"class="semi-title">주문상품</p>
					</div>
					<div style="display: flex;flex-direction: column;">
						<!--JSTL로 반복문 사용하여 주문상품 내역 출력하기-->	
						<c:forEach items="${orderList }" var="orderBook">
							<div style="width: 90%;height: 120px; margin: 0 auto; display: flex;margin-top: 20px;margin-bottom: 20px;">
								<div style="width: 90px;height: 100%;"><img style="width: 100%; height: 90%" alt="" src="${orderBook.book_cover }"></div>
								<div class="bookInfo" style="width: 45%;font-size: 14px;font-weight: bold;">
									<p>[주문 번호]${orderBook.order_no }</p>
								</div>
								<div class="bookInfo" style="width: 45%;font-size: 14px;font-weight: bold;">
									<p>[${orderBook.ccg_b001 }] ${orderBook.book_title }</p>
								</div>
								<div class="bookInfo" style="width: 15%; font-size: 14px;">
									<p>${orderBook.pl_cnt }개</p>
								</div>
								<div class="bookInfo" style="width: 30%;font-weight: bold;font-size: 14px;"><p>${orderBook.book_ntsl_amt *orderBook.pl_cnt }원</p></div>
							</div>			
						</c:forEach>
					</div>
				</div>
			</div>
			<div id="prodInfo" style="border: 1px solid #f7f7f7;background-color: #f7f7f7;height: 180px;border-radius: 10px;display: flex;align-items: center;">
				<div style="width: 90%;margin: 0 auto;">
					<p style="font-weight: bold;">유의사항</p>
					<span>구매 확정일이 지난 이후에는 환불이 불가능합니다.</span><br>
					<span>상품구입 후 구매확정이된 이후에 마일리지 적립이 가능합니다.</span><br>
					<span>마일리지를 사용하여 상품을 구매 시 마일리지 적립이 되지 않습니다.</span><br>
					<span>e-Book구매 시 환불이 불가능합니다.</span><br>
				</div>
			</div>
		</div>
	</div>
</body>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<!--결제 API -->
<script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.1.5.js"></script>
<script>
	let printCurrentProd = document.querySelector("#printCurrentProd");

	let xhr1 = new XMLHttpRequest();
	xhr1.open("GET", "/harubooks/myPage/currentPurchase", true);
	xhr1.onload = function () {
  	if (xhr1.status === 200) {
    	var data1 = JSON.parse(xhr1.responseText);
    	console.log(data1); // 데이터 전체를 확인해 보세요
    	let code = "";
		if(data1 == '' || data1 == null){
			code += "<div style='width: 90%;height: 120px; margin: 0 auto; display: flex;margin-top: 20px;margin-bottom: 20px;align-items: center;'>";
			code += "<div class='bookInfo' style='width: 100%;font-size: 16px;font-weight: bold;'><p style='text-align: center;'>주문한 상품이 존재하지 않습니다</p></div>";
			code += "</div>";

		}else{
			for (let i = 0; i < data1.length; i++) {
			code += "<div style='width: 90%;height: 120px; margin: 0 auto; display: flex;margin-top: 20px;margin-bottom: 20px;align-items: center;'>";
			code += "<div class='bookInfo' style='width: 30%;font-size: 14px;font-weight: bold;'><p>" + data1[i].order_no + "</p></div>";
			code += "<div class='bookInfo' style='width: 90px;height: 90%;'><img style='width: 100%; height: 90%' alt='' src='" + data1[i].book_cover + "'></div>";
			code += "<div class='bookInfo' style='width: 55%;font-size: 14px;font-weight: bold;'><p>[" + data1[i].ccg_b001 + "] " + data1[i].book_title + "</p></div>";
			code += "<div class='bookInfo' style='width: 15%; font-size: 14px;'><p>" + data1[i].pl_cnt + "개</p></div>";
			code += "<div class='bookInfo' style='width: 20%;font-weight: bold;font-size: 14px;'><p>" + (data1[i].book_ntsl_amt * data1[i].pl_cnt) + "원</p></div>";
			code += "<div class='bookInfo' style='width: 35%;font-weight: bold;font-size: 14px;'><p>[배송상태] " + (data1[i].ccg_d001) + "</p></div>";
			code += "</div>";
			}
		}
    	printCurrentProd.innerHTML = code;

 	 } else {
    	console.error(xhr1.status);
  	}
	};
	xhr1.send();

</script>
